// Fill out your copyright notice in the Description page of Project Settings.

#pragma once

#include "CoreMinimal.h"
#include "GameFramework/GameModeBase.h"
#include "Kismet/GameplayStatics.h"
#include "Math/UnrealMathUtility.h"
#include "StatistiquesDuJoueur.h"
#include "EngineUtils.h"
#include "TimerManager.h"
#include "Portail.h"
#include "GestionnaireDeNiveaux.h"
#include "Personnage/Personnage.h"
#include "GameFramework/PlayerStart.h"
#include "InformationsNiveau.h"
#include "Blueprint/UserWidget.h"
#include "ModeDeJeu_MenuPrincipal.generated.h"

/**
 * 
 */
UCLASS()
class PORTAILCPP_API AModeDeJeu_MenuPrincipal : public AGameModeBase
{
	GENERATED_BODY()

	AGestionnaireDeNiveaux* GestionnaireDeNiveaux;

	void PlacerUnUniqueJoueur();

	//-----------------------------------------
	//---------OUVERTURE DE LA PARTIE----------
	//-----------------------------------------

	//vide le tableau et le remplis selon le nombre de joueurs
	void InitialiserStatsJoueurs();

	//liste de tous les niveaux qui ont été choisis par le générateur de carte au lancement d'une partie
	TArray<InformationsNiveau*> NiveauxChoisis;

	//choisis les niveaux qui seront utilisés pendant la partie
	void SelectionnerNiveaux(TArray<InformationsNiveau*> ListeCompleteNiveaux, int NbNiveauxVoulus);

	//sélectionne quels niveaux seront connectés ensemble (NE CONNECTE PAS LES PORTAILS)
	void RelierNiveaux();

	//charge les niveaux
	void ChargerLesNiveaux();

	//connecte les portails de tous les niveaux de manière à ce que tous les niveaux soient accessibles
	void ConnecterLesPortails();

	//Trouve tous les acteurs de type APortail chargés dans le jeu, et les stock dans NiveauxChoisis
	void TrouverTousLesPortailsCharges();

	//Trouve tous les acteurs de type PointApparition chargés dans le jeu, et les stock dans NiveauChoisis
	void ChercherPointsApparition();

	//Supprime tous les objets APersonnage déjà présent (ex: le personnage par défaut), et en crée un certain nombre, placés dans les PointsApparitions sélectionnés précédemment
	void PlacerJoueurs();

	//retourne vrai si tous les niveaux ont terminé d'être chargés
	bool NiveauxTousCharges();

	//retourne vrai si on trouve autant de portails qu'il est supposé y en avoir
	bool CompterPortails();

	//connecte les portails, va chercher les points d'apparition et fait apparaître les joueurs
	void InitialiserCarte();

	//-----------------------------------------
	//---------FERMETURE DE LA PARTIE----------
	//-----------------------------------------

	void PartieTerminee(int idNoJoueurGagnant);

	//décharge tous les niveaux
	void DechargerCarte();

	void DetruireTousLesJoueurs();

	//détruit un joueur spécifié
	void DetruireJoueur(int NoJoueur);

	int NombreDeJoueursExistants();

	bool AttendreDetruireTousLesJoueurs();

	void RetourMenuPrincipal();

	//-----------------------------------------
	//--------DÉROULEMENT DE LA PARTIE---------
	//-----------------------------------------

	//fait apparaitre un joueur sur un point d'apparition aléatoire
	void ReapparitionJoueur(int NoJoueur);

	//fait apparaitre un joueur au point d'apparition spécifié avec l'ID du PlayerController spécifié
	void FaireApparaitreJoueur(AActor * PointApparition, int NoJoueur);

	void AttendreQueJoueurCharge(APlayerController * Controleur, int NoJoueur, AActor * PointApparition);


	APersonnage * GetJoueurParIndex(int NoJoueur);

	//retourne un point d'apparition aléatoire (à remplacer plus tard par un point d'apparition dans un pièce où il n'y a pas de joueur)
	APlayerStart * TrouverPointApparitionAleatoire();

	int NbMeutresRequisPourVictoire;

	//sera plus élevé quand on aura plus de niveaux de faits
	///IMPORTANT!!! DOIT ÊTRE PLUS PETIT OU ÉGAL À LA TAILLE DE LA LISTE DE NIVEAUX
	int NbNiveauxVoulus;

	//nombre de joueurs qui participeront dans la partie
	int NbJoueurs;

	//gèrent la fin de la partie avec le timer
public:
	void TerminerPartieTimer();
	
private:
	FTimerHandle TimerHandleFinDePartie;

	TArray<float> SensibiliteH;
	TArray<float> SensibiliteV;

	
public:
	AModeDeJeu_MenuPrincipal();

	UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "MenuPrincipal")
	TSubclassOf<UUserWidget> StartingWidgetClass;

	UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "WidgetPartie")
	TSubclassOf<UUserWidget> WidgetEnPartie;
	
	//le numéro du joueur gagnant. si égal à -1, le menu ne l'affichera pas
	UPROPERTY(BlueprintReadOnly, Category = "MenuPrincipal")
	int NoJoueurGagnant = -1;

	UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "MenuPrincipal")
	TArray<UStatistiquesDuJoueur*> StatsJoueurs;

	//le temps maximal qu'une partie peut durer
	UPROPERTY(BlueprintReadOnly, Category = "Timer")
	int TempsMaxPartie = 300;

	virtual void BeginPlay() override;

	UPROPERTY()
	UUserWidget* CurrentWidget;
	
	UFUNCTION(BlueprintCallable, Category = "MenuPrincipal")
	void ChangeMenuWidget(TSubclassOf<UUserWidget> NewWidgetClass);

	//appelé lorsqu'un joueur meurt
	void JoueurEnTueUnAutre(int IndexJoueurTueur, int IndexJoueurMort);

	//appelle toutes les fonctions d'ouverture de la partie
	UFUNCTION(BlueprintCallable, Category = "GenerationCarte")
		void GenererCarte(int _NbJoueurs, int nb_pieces, int nb_points_victoire, int duree, UPARAM(ref) TArray<float>& SensibiliteH, UPARAM(ref) TArray<float>& SensibiliteV);
};
